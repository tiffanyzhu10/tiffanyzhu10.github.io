opacity = 1)) %>%
addLegend(data = pge_map_avg,
pal = res_pal,
values = ~DIFF,
title = "Difference in Electricity<br>Consumption per Customer<br>between April 2017-19<br>and 2020")
# Same as above
pge_map_avg = pge_bay %>% filter(MONTH == "4" &
(CUSTOMERCLASS == "Elec- Commercial" |
CUSTOMERCLASS == "Elec- Residential")) %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0) %>%
group_by(ZIPCODE) %>%
summarize(`2017` = sum(`2017`, na.rm = T),
`2018` = sum(`2018`, na.rm = T),
`2019` = sum(`2019`, na.rm = T),
`2020` = sum(`2020`, na.rm = T)) %>%
filter(`2017` > 0 &
`2018` > 0 &
`2019` > 0 &
`2020` > 0)
pge_map_avg = pge_map_avg %>% mutate(AVG = rowMeans(pge_map_avg[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Reds",
domain = pge_map_avg$DIFF,
reverse = TRUE)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_avg,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_avg,
pal = res_pal,
values = ~DIFF,
title = "Difference in Electricity<br>Consumption per Customer<br>between April 2017-19<br>and 2020")
# Create the new dataset
# Widen the dataset so that each year has a column for its usage values
# Because total customers may vary slightly from year to year, the rows don't collapse automatically, so collapse the rows.
# Create new column representing difference between 2020 and 2017-19 average usage
# Split steps because otherwise there is an error generating the average usage column
# Append geometry information
pge_map = pge_bay %>% filter(MONTH == "4" &
(CUSTOMERCLASS == "Elec- Commercial" |
CUSTOMERCLASS == "Elec- Residential")) %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS)) %>%
spread(YEAR, TOTALKBTU, fill = 0) %>%
group_by(ZIPCODE) %>%
summarize(`2017` = sum(`2017`, na.rm = T),
`2018` = sum(`2018`, na.rm = T),
`2019` = sum(`2019`, na.rm = T),
`2020` = sum(`2020`, na.rm = T)) %>%
filter(`2017` > 0 &
`2018` > 0 &
`2019` > 0 &
`2020` > 0)
pge_map = pge_map %>% mutate(AVG = rowMeans(pge_map[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map$DIFF)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map,
pal = res_pal,
values = ~DIFF,
title = "Difference in Electricity<br>Consumption between<br>April 2017-19 and 2020")
# Same as above
pge_map_avg = pge_bay %>% filter(MONTH == "4" &
(CUSTOMERCLASS == "Elec- Commercial" |
CUSTOMERCLASS == "Elec- Residential")) %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0) %>%
group_by(ZIPCODE) %>%
summarize(`2017` = sum(`2017`, na.rm = T),
`2018` = sum(`2018`, na.rm = T),
`2019` = sum(`2019`, na.rm = T),
`2020` = sum(`2020`, na.rm = T)) %>%
filter(`2017` > 0 &
`2018` > 0 &
`2019` > 0 &
`2020` > 0)
pge_map_avg = pge_map_avg %>% mutate(AVG = rowMeans(pge_map_avg[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Reds",
domain = pge_map_avg$DIFF,
reverse = TRUE)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_avg,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_avg,
pal = res_pal,
values = ~DIFF,
title = "Difference in Electricity<br>Consumption per Customer<br>between April 2017-19<br>and 2020")
# Repeat data cleaning steps in creation of pge_map
pge_map_comm = pge_bay %>% filter(MONTH == "4" &
CUSTOMERCLASS == "Elec- Commercial") %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0) %>%
filter(`2017` > 0 &
`2018` > 0 &
`2019` > 0 &
`2020` > 0)
pge_map_comm = pge_map_comm %>%
mutate(AVG = rowMeans(pge_map_comm[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map_comm$DIFF)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_comm,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_comm,
pal = res_pal,
values = ~DIFF,
title = "Difference in Commercial<br>Electricity Consumption<br>between April 2017-19<br>and 2020")
# Repeat data cleaning steps in creation of pge_map
pge_map_comm = pge_bay %>% filter(MONTH == "4" &
CUSTOMERCLASS == "Elec- Commercial") %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0) %>%
filter(`2017` > 0 &
`2018` > 0 &
`2019` > 0 &
`2020` > 0)
pge_map_comm = pge_map_comm %>%
mutate(AVG = rowMeans(pge_map_comm[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map_comm$DIFF)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_comm,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_comm,
pal = res_pal,
values = ~DIFF,
title = "Difference in Commercial<br>Electricity Consumption<br>per Customer<br>between April 2017-19<br>and 2020")
# Repeat data cleaning steps in creation of pge_map
pge_map_res = pge_bay %>% filter(MONTH == "4" &
CUSTOMERCLASS == "Elec- Residential") %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0) %>%
filter(`2017` > 0 &
`2018` > 0 &
`2019` > 0 &
`2020` > 0)
pge_map_res = pge_map_res %>%
mutate(AVG = rowMeans(pge_map_res[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map_res$DIFF)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_res,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_res,
pal = res_pal,
values = ~DIFF,
title = "Difference in Residential<br>Electricity Consumption<br>between April 2017-19<br>and 2020")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Commercial" & ZIPCODE == "94043")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Commercial" & ZIPCODE == "94043" & MONTH == "4")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Commercial" & ZIPCODE == "94043" & MONTH == "5")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Commercial" & ZIPCODE == "94043" & YEAR == "2020")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Commercial" & ZIPCODE == "94043" & MONTH == "4")
pge_map_comm
# Repeat data cleaning steps in creation of pge_map
pge_map_comm = pge_bay %>% filter(MONTH == "4" &
CUSTOMERCLASS == "Elec- Commercial") %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0)
pge_map_comm = pge_map_comm %>%
mutate(AVG = rowMeans(pge_map_comm[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map_comm$DIFF)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_comm,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_comm,
pal = res_pal,
values = ~DIFF,
title = "Difference in Commercial<br>Electricity Consumption<br>per Customer<br>between April 2017-19<br>and 2020")
# Repeat data cleaning steps in creation of pge_map
pge_map_comm = pge_bay %>% filter(MONTH == "4" &
CUSTOMERCLASS == "Elec- Commercial") %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0)
pge_map_comm = pge_map_comm %>%
mutate(AVG = rowMeans(pge_map_comm[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map_comm$DIFF,
reverse == TRUE)
# Repeat data cleaning steps in creation of pge_map
pge_map_comm = pge_bay %>% filter(MONTH == "4" &
CUSTOMERCLASS == "Elec- Commercial") %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0)
pge_map_comm = pge_map_comm %>%
mutate(AVG = rowMeans(pge_map_comm[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map_comm$DIFF,
reverse = TRUE)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_comm,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_comm,
pal = res_pal,
values = ~DIFF,
title = "Difference in Commercial<br>Electricity Consumption<br>per Customer<br>between April 2017-19<br>and 2020")
# Same as above
pge_map_avg = pge_bay %>% filter(MONTH == "4" &
(CUSTOMERCLASS == "Elec- Commercial" |
CUSTOMERCLASS == "Elec- Residential")) %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0) %>%
group_by(ZIPCODE) %>%
summarize(`2017` = sum(`2017`, na.rm = T),
`2018` = sum(`2018`, na.rm = T),
`2019` = sum(`2019`, na.rm = T),
`2020` = sum(`2020`, na.rm = T)) %>%
filter(!(`2017` == 0 &
`2018` == 0 &
`2019` == 0 &
`2020` == 0))
pge_map_avg = pge_map_avg %>% mutate(AVG = rowMeans(pge_map_avg[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Reds",
domain = pge_map_avg$DIFF,
reverse = TRUE)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_avg,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_avg,
pal = res_pal,
values = ~DIFF,
title = "Difference in Electricity<br>Consumption per Customer<br>between April 2017-19<br>and 2020")
# Create the new dataset
# Widen the dataset so that each year has a column for its usage values
# Because total customers may vary slightly from year to year, the rows don't collapse automatically, so collapse the rows.
# Create new column representing difference between 2020 and 2017-19 average usage
# Split steps because otherwise there is an error generating the average usage column
# Append geometry information
pge_map = pge_bay %>% filter(MONTH == "4" &
(CUSTOMERCLASS == "Elec- Commercial" |
CUSTOMERCLASS == "Elec- Residential")) %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS)) %>%
spread(YEAR, TOTALKBTU, fill = 0) %>%
group_by(ZIPCODE) %>%
summarize(`2017` = sum(`2017`, na.rm = T),
`2018` = sum(`2018`, na.rm = T),
`2019` = sum(`2019`, na.rm = T),
`2020` = sum(`2020`, na.rm = T)) %>%
filter(!(`2017` == 0 &
`2018` == 0 &
`2019` == 0 &
`2020` == 0))
pge_map = pge_map %>% mutate(AVG = rowMeans(pge_map[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map$DIFF)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map,
pal = res_pal,
values = ~DIFF,
title = "Difference in Electricity<br>Consumption between<br>April 2017-19 and 2020")
# Repeat data cleaning steps in creation of pge_map
pge_map_comm = pge_bay %>% filter(MONTH == "4" &
CUSTOMERCLASS == "Elec- Commercial") %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0) %>%
filter(!(`2017` == 0 &
`2018` == 0 &
`2019` == 0 &
`2020` == 0))
pge_map_comm = pge_map_comm %>%
mutate(AVG = rowMeans(pge_map_comm[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map_comm$DIFF,
reverse = TRUE)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_comm,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_comm,
pal = res_pal,
values = ~DIFF,
title = "Difference in Commercial<br>Electricity Consumption<br>per Customer<br>between April 2017-19<br>and 2020")
# Repeat data cleaning steps in creation of pge_map
pge_map_res = pge_bay %>% filter(MONTH == "4" &
CUSTOMERCLASS == "Elec- Residential") %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0) %>%
filter(!(`2017` == 0 &
`2018` == 0 &
`2019` == 0 &
`2020` == 0))
pge_map_res = pge_map_res %>%
mutate(AVG = rowMeans(pge_map_res[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map_res$DIFF)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_res,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_res,
pal = res_pal,
values = ~DIFF,
title = "Difference in Residential<br>Electricity Consumption<br>between April 2017-19<br>and 2020")
# Repeat setup steps in creation of pge_map
pge_map_res = pge_bay %>% filter(MONTH == "4" &
CUSTOMERCLASS == "Elec- Residential") %>%
select(!c(MONTH, COMBINED, DATE, TOTALCUSTOMERS, TOTALKBTU)) %>%
spread(YEAR, AVERAGEKBTU, fill = 0) %>%
filter(!(`2017` == 0 &
`2018` == 0 &
`2019` == 0 &
`2020` == 0))
pge_map_res = pge_map_res %>%
mutate(AVG = rowMeans(pge_map_res[,c("2017", "2018", "2019")],
na.rm = T),
DIFF = `2020` - AVG) %>%
left_join(bay_zips %>% select(GEOID10),
by = c("ZIPCODE" = "GEOID10")) %>%
st_as_sf() %>%
st_transform(4326)
# Draw map
res_pal = colorNumeric(palette = "Blues",
domain = pge_map_res$DIFF)
leaflet() %>% addTiles() %>%
addPolygons(data = pge_map_res,
fillColor = ~res_pal(DIFF),
color = "white",
opacity = 0.5,
fillOpacity = 0.5,
weight = 1,
label = ~paste0(DIFF, " kBTU change in ", ZIPCODE),
highlightOptions = highlightOptions(weight = 2,
opacity = 1)) %>%
addLegend(data = pge_map_res,
pal = res_pal,
values = ~DIFF,
title = "Difference in Residential<br>Electricity Consumption<br>per Customer<br>between April 2017-19<br>and 2020")
pge_map_res[order(-DIFF)]
pge_map_res[order(-DIFF),]
pge_map_res[order(-pge_map_res$DIFF),]
pge_map_res[order(pge_map_res$DIFF),]
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Residential" & ZIPCODE == "94612")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Residential" & ZIPCODE == "94612" & YEAR == "2020")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Residential" & ZIPCODE == "94612" & MONTH == "4")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Residential" & ZIPCODE == "94938" & MONTH == "4")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Residential" & ZIPCODE == "94940" & MONTH == "4")
pge_bay %>% filter(CUSTOMERCLASS == "Elec- Residential" & ZIPCODE == "95412" & MONTH == "4")
