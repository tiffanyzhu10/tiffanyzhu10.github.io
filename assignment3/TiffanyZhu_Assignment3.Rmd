---
title: "PUBLPOL 218X Assignment 3"
author: "Tiffany Zhu"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/GitHub/tiffanyzhu10.github.io/assignment3")
library(tidyverse)
library(plotly)
library(sf)
library(tigris)
library(leaflet)
library(zoo)
library(censusapi)
library(tidycensus)

census_api_key("5ace7165d1f551af1a6a8876ee3986faa544ea83")

Sys.setenv(CENSUS_KEY="5ace7165d1f551af1a6a8876ee3986faa544ea83")
```

# PUMS Multiple Regression: Marital Status

I have read a few articles [cite sources] that claim that marital status increasingly depends on socioeconomic status. Supposedly, those who get married are increasingly high-income, well-educated individuals, while lower-income and less-educated people are choosing not to marry.

I will test those claims by studying the relationship between marital status (which I set as my dependent variable) and income and educational attainment (which I set as my independent variables). This analysis will be at the census tract level. I will focus on individuals aged 18 or older, since individuals under 18 rarely marry.

## Data setup

``` {r pums_setup, eval = F}

ca_pums = get_pums(variables = c("PUMA", "AGEP", "MAR", "SCHL", "PINCP"),
                   state = "CA",
                   year = 2019,
                   survey = "acs1",
                   recode = T)
saveRDS(ca_pums, file = "ca_pums.rds")

```

``` {r pums1, echo = T, warning = F, message = F}
# Get PUMS and PUMAS data

pums_vars_2019 = pums_variables %>%
                 filter(year == 2019, survey == "acs1")
pums_vars_2019_inds = pums_vars_2019 %>%
                      distinct(var_code, var_label, data_type, level) %>%
                      filter(level == "person")
ca_pums = readRDS("ca_pums.rds")
ca_pumas = pumas("CA", cb = T, progress_bar = F)

# Isolate Bay Area PUMS

bay_county_names =
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Francisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )

ca_counties = counties("CA", cb = T, progress_bar = F)
bay_counties = ca_counties %>%
               filter(NAME %in% bay_county_names)

bay_pumas = ca_pumas %>%
            st_centroid() %>%
            .[bay_counties, ] %>%
            mutate(PUMACE10 = as.numeric(PUMACE10)) %>%
            st_set_geometry(NULL) %>%
            left_join(ca_pumas %>% select(GEOID10)) %>%
            st_as_sf()
bay_pums = ca_pums %>%
           mutate(PUMA = as.numeric(PUMA)) %>%
           filter(PUMA %in% bay_pumas$PUMACE10)

bay_pums
```

``` {r pums2, echo = T, message = F, warning = F}
# Clean dataset
# Filter out all children under age 3 (SCHL == bb)
# Convert "character"-encoded variables MAR and SCHL to doubles
# Filter dataset so all individuals are over 18 years old
# Create new variable "married" representing number of ever-married individuals in each PUMA
# Create new variable "college" representing number of college-educated individuals in each PUMA
# Collapse to PUMAs
# Calculate percentage of married and college-educated people in each PUMA

bay_marriage = bay_pums %>%
               filter(SCHL != "bb") %>%
               mutate(MAR = as.numeric(MAR),
                      SCHL = as.numeric(SCHL)) %>%
               filter(AGEP >= 18) %>%
               mutate(married = ifelse(
                        (MAR < 5),
                        PWGTP,
                        0),
                      college = ifelse(
                        (SCHL >= 21),
                        PWGTP,
                        0
                      )
               ) %>%
               group_by(PUMA) %>%
               summarize(mean_personal_income = weighted.mean(PINCP, PWGTP, na.rm = T),
                         perc_married = sum(married, na.rm = T)/
                                        sum(PWGTP, na.rm = T)*100,
                         perc_college = sum(college, na.rm = T)/
                                        sum(PWGTP, na.rm = T)*100)

bay_marriage
```

## Testing single regressions: income vs. marriage rate

``` {r pums3, echo = T}
# Regression

model = lm(perc_married ~ mean_personal_income, bay_marriage)
summary(model)

# Scatterplot

ggplot(data = bay_marriage,
       aes(x = mean_personal_income,
           y = perc_married)) +
  geom_point() +
  geom_smooth(method = "lm")
```

From the regression, it doesn't seem that personal income itself has an impact on the likelihood of marriage in any given census tract. A scatterplot seems to show a positive correlation between personal income and marriage rates, but the margin of error for this line is high â€” it's possible to draw a straight line through the area covered by the margin of error.

## Testing single regressions: educational attainment vs. marriage rate

``` {r pums4, echo = T}
# Regression

model = lm(perc_married ~ perc_college, bay_marriage)
summary(model)

# Scatterplot

ggplot(data = bay_marriage,
       aes(x = perc_college,
           y = perc_married)) +
  geom_point() +
  geom_smooth(method = "lm")
```

It also appears from the regression that having a college education does not have an impact on marriage rates. The scatterplot shows an essentially flat line with a large margin of error, suggesting that it is unlikely the two are related.

## Adding it up: multiple regression

``` {r pums5, echo = T}
# Regression

model = lm(perc_married ~ mean_personal_income + perc_college, bay_marriage)
summary(model)

```

When regressing both together, it seems that both factors have a significant impact on marriage rates. Increases in mean personal income correspond to increases in marriage rates, as predicted in my hypothesis. Contrary to my hypothesis, increases in college attendance correspond to *decreases* in marriage rates. However, this effect seems to be less pronounced than the income effect.

From this regression, it is possible to conclude that wealthier people are more likely to get married than poorer people. This trend overrides a tendency for college-educated people to get married less often than non-college-educated people.

# CBG/Tract/ZCTA Regression: X, Y, and Z



``` {r data2, echo = T}

```