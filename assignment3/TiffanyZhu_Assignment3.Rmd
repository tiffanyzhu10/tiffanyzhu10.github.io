---
title: "PUBLPOL 218X Assignment 3"
author: "Tiffany Zhu"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/GitHub/tiffanyzhu10.github.io/assignment3")
library(tidyverse)
library(plotly)
library(sf)
library(tigris)
library(leaflet)
library(zoo)
library(censusapi)
library(tidycensus)
library(corrplot)

census_api_key("5ace7165d1f551af1a6a8876ee3986faa544ea83")

Sys.setenv(CENSUS_KEY="5ace7165d1f551af1a6a8876ee3986faa544ea83")
```

# PUMS Multiple Regression: Marital Status

Many recent studies have found that marital status increasingly correlates with socioeconomic status ([UPenn Wharton Budget Model](https://budgetmodel.wharton.upenn.edu/issues/2016/2/3/socioeconomic-patterns-of-marriage-and-divorce), [Pew Research](https://www.pewresearch.org/fact-tank/2017/09/14/as-u-s-marriage-rate-hovers-at-50-education-gap-in-marital-status-widens/), [American Enterprise Institute](https://www.aei.org/research-products/report/the-marriage-divide-how-and-why-working-class-families-are-more-fragile-today/)). In particular, these studies have shown that those who get married are increasingly high-income, college-educated individuals who have the financial stability to support a family.

I will use individual-level Census PUMS data to see if these trends also hold in the Bay Area. In this section, I study the relationship between marital status (which I set as my dependent variable) and income and educational attainment (which I set as my independent variables) in the Bay Area. This analysis will be at the PUMA level. I will focus on individuals aged 18 or older, since individuals under 18 rarely marry.

## Data setup

``` {r pums_setup, eval = F}

ca_pums = get_pums(variables = c("PUMA", "AGEP", "MAR", "SCHL", "PINCP"),
                   state = "CA",
                   year = 2019,
                   survey = "acs1",
                   recode = T)
saveRDS(ca_pums, file = "ca_pums.rds")

```

``` {r pums1, echo = T, warning = F, message = F}
# Get PUMS and PUMAS data

pums_vars_2019 = pums_variables %>%
                 filter(year == 2019, survey == "acs1")
pums_vars_2019_inds = pums_vars_2019 %>%
                      distinct(var_code, var_label, data_type, level) %>%
                      filter(level == "person")
ca_pums = readRDS("ca_pums.rds")
ca_pumas = pumas("CA", cb = T, progress_bar = F)

# Isolate Bay Area PUMS

bay_county_names =
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Francisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )

ca_counties = counties("CA", cb = T, progress_bar = F)
bay_counties = ca_counties %>%
               filter(NAME %in% bay_county_names)

bay_pumas = ca_pumas %>%
            st_centroid() %>%
            .[bay_counties, ] %>%
            mutate(PUMACE10 = as.numeric(PUMACE10)) %>%
            st_set_geometry(NULL) %>%
            left_join(ca_pumas %>% select(GEOID10)) %>%
            st_as_sf()
bay_pums = ca_pums %>%
           mutate(PUMA = as.numeric(PUMA)) %>%
           filter(PUMA %in% bay_pumas$PUMACE10)

bay_pums
```

``` {r pums2, echo = T, message = F, warning = F}
# Clean dataset
# Filter out all children under age 3 (SCHL == bb)
# Convert "character"-encoded variables MAR and SCHL to doubles
# Filter dataset so all individuals are over 18 years old
# Create new variable "married" representing number of ever-married individuals in each PUMA
# Create new variable "college" representing number of college-educated individuals in each PUMA
# Collapse to PUMAs
# Calculate percentage of married and college-educated people in each PUMA
# Additionally calculate weighted mean income in each PUMA

bay_marriage = bay_pums %>%
               filter(SCHL != "bb") %>%
               mutate(MAR = as.numeric(MAR),
                      SCHL = as.numeric(SCHL)) %>%
               filter(AGEP >= 18) %>%
               mutate(married = ifelse(
                        (MAR < 5),
                        PWGTP,
                        0),
                      college = ifelse(
                        (SCHL >= 21),
                        PWGTP,
                        0
                      )
               ) %>%
               group_by(PUMA) %>%
               summarize(mean_personal_income = weighted.mean(PINCP, PWGTP, na.rm = T),
                         perc_married = sum(married, na.rm = T)/
                                        sum(PWGTP, na.rm = T)*100,
                         perc_college = sum(college, na.rm = T)/
                                        sum(PWGTP, na.rm = T)*100)

bay_marriage
```

## Single regression: income vs. marriage rate

``` {r pums3, echo = T}
# Regression

model = lm(perc_married ~ mean_personal_income, bay_marriage)
summary(model)

# Scatterplot

ggplot(data = bay_marriage,
       aes(x = mean_personal_income,
           y = perc_married)) +
  geom_point() +
  geom_smooth(method = "lm")
```

From the regression, it doesn't seem that personal income itself has an impact on the likelihood of marriage in any given census tract. (An increase in $10,000 in income corresponds to a 0.5 percentage point increase in marriage rate, a small increase indeed.) A scatterplot seems to show a positive correlation between personal income and marriage rates, but the margin of error for this line is high â€” it's possible to draw a straight line through the area covered by the margin of error.

## Single regression: educational attainment vs. marriage rate

``` {r pums4, echo = T}
# Regression

model = lm(perc_married ~ perc_college, bay_marriage)
summary(model)

# Scatterplot

ggplot(data = bay_marriage,
       aes(x = perc_college,
           y = perc_married)) +
  geom_point() +
  geom_smooth(method = "lm")
```

It also appears from the regression that having a college education does not have an impact on marriage rates. The scatterplot shows an essentially flat line with a large margin of error, suggesting that it is unlikely the two are related.

## Multiple regression

``` {r pums5, echo = T}
# Correlation plot

correlationplot = bay_marriage %>%
                  select(mean_personal_income,
                         perc_college,
                         perc_married) %>%
                  cor()
corrplot(correlationplot,
         method = "number",
         type = "upper")
```

Before interpreting regression results, it is important to note that college education and income are highly correlated, as shown in the correlation plot above. Thus there is bound to be collinearity in this regression, which undermines the model's predictive power.

``` {r pums6, echo = T}
# Regression

model = lm(perc_married ~ mean_personal_income + perc_college, bay_marriage)
summary(model)
```

When regressing both together, it seems that both factors have a significant impact on marriage rates. Increases in mean personal income correspond to increases in marriage rates, as predicted in my hypothesis. Contrary to what the above cited studies find, increases in college attendance correspond to *decreases* in marriage rates. However, this effect seems to be less pronounced than the income effect.

A few caveats that might explain this discrepancy is ???

# CBG/Tract/ZCTA-Level Regression: Sleep Deprivation

According to the [CDC](https://www.cdc.gov/sleep/data_statistics.html) and a study published in [*Sleep Medicine*](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2861987/), poorer people tend to sleep less than richer people. Additionally, a recent meta-analysis in [*Sleep Health*](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5771439/) finds that white children and adolescents tend to sleep more than their non-white peers. Intuitively, it makes sense that poorer people sleep less, since they may work longer hours and undergo more stresses related to financial insecurity. Since people of color, especially Black and Hispanic/Latinx people, are disproportionately likely to be poor, it also makes sense that race correlates with sleep deprivation.

In this section, I investigate whether this relationship persists in the Bay Area. I conduct a Census tract-level analysis using data from the CDC's [500 Cities](https://www.cdc.gov/500cities/index.htm) project and the 2018 American Community Survey 5-year estimates.

## Data setup: 500 Cities data

``` {r tract_setup1, echo = T, message = F, warning = F}

all_health = read_csv("https://chronicdata.cdc.gov/api/views/6vp6-wxuq/rows.csv?accessType=DOWNLOAD")
ca_health = filter(all_health, StateAbbr == "CA")
ca_sleep = filter(ca_health, MeasureId == "SLEEP")

# Filter to Bay Area census tracts
ca_tracts = tracts("CA", cb = T, progress_bar = F)

bay_sleep = ca_sleep %>%
            filter(!is.na(TractFIPS)) %>%
            filter(!is.na(Data_Value)) %>%
            left_join(ca_tracts %>% select(GEOID),
                      by = c("TractFIPS" = "GEOID")) %>%
            st_as_sf() %>%
            st_centroid() %>%
            .[bay_counties, ] %>%
            st_set_geometry(NULL) %>%
            left_join(ca_tracts %>% select(GEOID),
                      by = c("TractFIPS" = "GEOID")) %>%
            st_as_sf()

bay_sleep
```

## Mapping sleep deprivation

``` {r tracts1, echo = T, warning = F, message = F}
sleep_pal = colorNumeric(palette = "Purples",
                         domain = bay_sleep$Data_Value)

leaflet() %>%
  addTiles() %>%
  addPolygons(
    data = bay_sleep,
    fillColor = ~sleep_pal(Data_Value),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(round(Data_Value), "% in ", TractFIPS),
    highlightOptions = highlightOptions(weight = 2,
                                        opacity = 1)) %>%
    addLegend(data = bay_sleep,
              pal = sleep_pal,
              values = ~Data_Value,
              title = "Percentage of residents<br>who sleep less than 7<br>hours per night")
```

## Data setup: ACS 2018 5-Year Data

We use ACS 2018 5-year data because tract-level data is only available in the 5-year surveys.

``` {r tract_setup2, echo = T}
acs_vars_2018_5yr = listCensusMetadata(name = "2018/acs/acs5",
                                       type = "variables")

bay_income_race = getCensus(name = "acs/acs5",
                            vintage = 2018,
                            region = "tract:*",
                            regionin = "state:06+county:001,013,041,055,075,081,085,095,097",
                            vars = c("B19001A_001E",
                                     "B19001_001E",
                                     "B19013_001E")) %>%
                  transmute(tract = paste0(state, county, tract),
                            perc_white = B19001A_001E / B19001_001E * 100,
                            med_income = B19013_001E) %>%
                  filter(!is.na(perc_white),
                         !is.na(med_income))

bay_income_race
```

## Merging the datasets

``` {r tract_setup3, echo = T}
bay_sleep_income_race = bay_income_race %>%
                        left_join(bay_sleep %>% select(TractFIPS, Data_Value),
                                  by = c("tract" = "TractFIPS")) %>%
                        filter(!is.na(Data_Value))

bay_sleep_income_race
```

## Multiple regression



